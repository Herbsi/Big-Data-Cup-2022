arrow = arrow(length = unit(0.2, "cm")),size=1, colour='cyan')
plot_half_rink(p)
p <- ggplot(data = pass_potential,aes(x = x, y = y)) +
geom_point(aes(color = score_prob),size=2, shape=16) +
scale_colour_gradient2(na.value="white",low = muted("blue"), mid = "white", high = muted("red"))+#,midpoint = 0.5
scale_x_continuous(expand = c(0, 0)) +
scale_y_continuous(expand = c(0, 0)) +
#geom_point(aes(x = x, y = y), size = 1, shape = 4)+
new_scale_fill() +
new_scale_color() +
geom_point(data=tracking_data,aes(x = x_ft, y = y_ft, fill = team_name), size = 5, shape = 21) +
geom_text(data=tracking_data,aes(x = x_ft, y = y_ft, label = jersey_number, colour = team_name), size = 3) +
geom_point(aes(x = x_puck+2, y = y_puck-0.5), size = 2, shape = 16, colour='black') +
scale_colour_manual(values = c("USA" = "white", "Canada" = "white")) +
scale_fill_manual(values = c("USA" = "blue", "Canada" = "red")) +
labs(fill = "Team") +
guides(colour = "none")+
geom_segment(data=tracking_data,aes(x = x_ft, y = y_ft, xend = x_ft+vel_x, yend = y_ft+vel_y), #/sqrt(vel_x^2+vel_y^2) to get r=1
arrow = arrow(length = unit(0.2, "cm")),size=1, colour='cyan')
plot_half_rink(p)
p <- ggplot(data = pass_potential,aes(x = x, y = y)) +
geom_point(aes(color = pass_value),size=2, shape=16) +
scale_colour_gradient2(na.value="white",low = muted("blue"), mid = "white", high = muted("red"))+#,midpoint = 0.5
scale_x_continuous(expand = c(0, 0)) +
scale_y_continuous(expand = c(0, 0)) +
#geom_point(aes(x = x, y = y), size = 1, shape = 4)+
new_scale_fill() +
new_scale_color() +
geom_point(data=tracking_data,aes(x = x_ft, y = y_ft, fill = team_name), size = 5, shape = 21) +
geom_text(data=tracking_data,aes(x = x_ft, y = y_ft, label = jersey_number, colour = team_name), size = 3) +
geom_point(aes(x = x_puck+2, y = y_puck-0.5), size = 2, shape = 16, colour='black') +
scale_colour_manual(values = c("USA" = "white", "Canada" = "white")) +
scale_fill_manual(values = c("USA" = "blue", "Canada" = "red")) +
labs(fill = "Team") +
guides(colour = "none")+
geom_segment(data=tracking_data,aes(x = x_ft, y = y_ft, xend = x_ft+vel_x, yend = y_ft+vel_y), #/sqrt(vel_x^2+vel_y^2) to get r=1
arrow = arrow(length = unit(0.2, "cm")),size=1, colour='cyan')
plot_half_rink(p)
p <- ggplot(data = pass_potential,aes(x = x, y = y)) +
geom_point(aes(color = all_ctrl),size=2, shape=16) +
scale_colour_gradient2(na.value="white",low = muted("blue"), mid = "white", high = muted("red"))+#,midpoint = 0.5
scale_x_continuous(expand = c(0, 0)) +
scale_y_continuous(expand = c(0, 0)) +
#geom_point(aes(x = x, y = y), size = 1, shape = 4)+
new_scale_fill() +
new_scale_color() +
geom_point(data=tracking_data,aes(x = x_ft, y = y_ft, fill = team_name), size = 5, shape = 21) +
geom_text(data=tracking_data,aes(x = x_ft, y = y_ft, label = jersey_number, colour = team_name), size = 3) +
geom_point(aes(x = x_puck+2, y = y_puck-0.5), size = 2, shape = 16, colour='black') +
scale_colour_manual(values = c("USA" = "white", "Canada" = "white")) +
scale_fill_manual(values = c("USA" = "blue", "Canada" = "red")) +
labs(fill = "Team") +
guides(colour = "none")+
geom_segment(data=tracking_data,aes(x = x_ft, y = y_ft, xend = x_ft+vel_x, yend = y_ft+vel_y), #/sqrt(vel_x^2+vel_y^2) to get r=1
arrow = arrow(length = unit(0.2, "cm")),size=1, colour='cyan')
plot_half_rink(p)
p <- ggplot(data = pass_potential,aes(x = x, y = y)) +
geom_point(aes(color = cum_pass_off),size=2, shape=16) +
scale_colour_gradient2(na.value="white",low = muted("blue"), mid = "white", high = muted("red"))+#,midpoint = 0.5
scale_x_continuous(expand = c(0, 0)) +
scale_y_continuous(expand = c(0, 0)) +
#geom_point(aes(x = x, y = y), size = 1, shape = 4)+
new_scale_fill() +
new_scale_color() +
geom_point(data=tracking_data,aes(x = x_ft, y = y_ft, fill = team_name), size = 5, shape = 21) +
geom_text(data=tracking_data,aes(x = x_ft, y = y_ft, label = jersey_number, colour = team_name), size = 3) +
geom_point(aes(x = x_puck+2, y = y_puck-0.5), size = 2, shape = 16, colour='black') +
scale_colour_manual(values = c("USA" = "white", "Canada" = "white")) +
scale_fill_manual(values = c("USA" = "blue", "Canada" = "red")) +
labs(fill = "Team") +
guides(colour = "none")+
geom_segment(data=tracking_data,aes(x = x_ft, y = y_ft, xend = x_ft+vel_x, yend = y_ft+vel_y), #/sqrt(vel_x^2+vel_y^2) to get r=1
arrow = arrow(length = unit(0.2, "cm")),size=1, colour='cyan')
plot_half_rink(p)
p <- ggplot(data = pass_potential,aes(x = x, y = y)) +
geom_point(aes(color = pass_value*cum_pass_off),size=2, shape=16) +
scale_colour_gradient2(na.value="white",low = muted("blue"), mid = "white", high = muted("red"))+#,midpoint = 0.5
scale_x_continuous(expand = c(0, 0)) +
scale_y_continuous(expand = c(0, 0)) +
#geom_point(aes(x = x, y = y), size = 1, shape = 4)+
new_scale_fill() +
new_scale_color() +
geom_point(data=tracking_data,aes(x = x_ft, y = y_ft, fill = team_name), size = 5, shape = 21) +
geom_text(data=tracking_data,aes(x = x_ft, y = y_ft, label = jersey_number, colour = team_name), size = 3) +
geom_point(aes(x = x_puck+2, y = y_puck-0.5), size = 2, shape = 16, colour='black') +
scale_colour_manual(values = c("USA" = "white", "Canada" = "white")) +
scale_fill_manual(values = c("USA" = "blue", "Canada" = "red")) +
labs(fill = "Team") +
guides(colour = "none")+
geom_segment(data=tracking_data,aes(x = x_ft, y = y_ft, xend = x_ft+vel_x, yend = y_ft+vel_y), #/sqrt(vel_x^2+vel_y^2) to get r=1
arrow = arrow(length = unit(0.2, "cm")),size=1, colour='cyan')
plot_half_rink(p)
p <- ggplot(data = pass_potential,aes(x = x, y = y)) +
geom_point(aes(color = cum_pass_off-cum_pass_def),size=2, shape=16) +
scale_colour_gradient2(na.value="white",low = muted("blue"), mid = "white", high = muted("red"))+#,midpoint = 0.5
scale_x_continuous(expand = c(0, 0)) +
scale_y_continuous(expand = c(0, 0)) +
#geom_point(aes(x = x, y = y), size = 1, shape = 4)+
new_scale_fill() +
new_scale_color() +
geom_point(data=tracking_data,aes(x = x_ft, y = y_ft, fill = team_name), size = 5, shape = 21) +
geom_text(data=tracking_data,aes(x = x_ft, y = y_ft, label = jersey_number, colour = team_name), size = 3) +
geom_point(aes(x = x_puck+2, y = y_puck-0.5), size = 2, shape = 16, colour='black') +
scale_colour_manual(values = c("USA" = "white", "Canada" = "white")) +
scale_fill_manual(values = c("USA" = "blue", "Canada" = "red")) +
labs(fill = "Team") +
guides(colour = "none")+
geom_segment(data=tracking_data,aes(x = x_ft, y = y_ft, xend = x_ft+vel_x, yend = y_ft+vel_y), #/sqrt(vel_x^2+vel_y^2) to get r=1
arrow = arrow(length = unit(0.2, "cm")),size=1, colour='cyan')
plot_half_rink(p)
p <- ggplot(data = pass_potential,aes(x = x, y = y)) +
geom_point(aes(color = cum_pass_good),size=2, shape=16) +
scale_colour_gradient2(na.value="white",low = muted("blue"), mid = "white", high = muted("red"))+#,midpoint = 0.5
scale_x_continuous(expand = c(0, 0)) +
scale_y_continuous(expand = c(0, 0)) +
#geom_point(aes(x = x, y = y), size = 1, shape = 4)+
new_scale_fill() +
new_scale_color() +
geom_point(data=tracking_data,aes(x = x_ft, y = y_ft, fill = team_name), size = 5, shape = 21) +
geom_text(data=tracking_data,aes(x = x_ft, y = y_ft, label = jersey_number, colour = team_name), size = 3) +
geom_point(aes(x = x_puck+2, y = y_puck-0.5), size = 2, shape = 16, colour='black') +
scale_colour_manual(values = c("USA" = "white", "Canada" = "white")) +
scale_fill_manual(values = c("USA" = "blue", "Canada" = "red")) +
labs(fill = "Team") +
guides(colour = "none")+
geom_segment(data=tracking_data,aes(x = x_ft, y = y_ft, xend = x_ft+vel_x, yend = y_ft+vel_y), #/sqrt(vel_x^2+vel_y^2) to get r=1
arrow = arrow(length = unit(0.2, "cm")),size=1, colour='cyan')
plot_half_rink(p)
p <- ggplot(data = pass_potential,aes(x = x, y = y)) +
geom_point(aes(color = pass_good),size=2, shape=16) +
scale_colour_gradient2(na.value="white",low = muted("blue"), mid = "white", high = muted("red"))+#,midpoint = 0.5
scale_x_continuous(expand = c(0, 0)) +
scale_y_continuous(expand = c(0, 0)) +
#geom_point(aes(x = x, y = y), size = 1, shape = 4)+
new_scale_fill() +
new_scale_color() +
geom_point(data=tracking_data,aes(x = x_ft, y = y_ft, fill = team_name), size = 5, shape = 21) +
geom_text(data=tracking_data,aes(x = x_ft, y = y_ft, label = jersey_number, colour = team_name), size = 3) +
geom_point(aes(x = x_puck+2, y = y_puck-0.5), size = 2, shape = 16, colour='black') +
scale_colour_manual(values = c("USA" = "white", "Canada" = "white")) +
scale_fill_manual(values = c("USA" = "blue", "Canada" = "red")) +
labs(fill = "Team") +
guides(colour = "none")+
geom_segment(data=tracking_data,aes(x = x_ft, y = y_ft, xend = x_ft+vel_x, yend = y_ft+vel_y), #/sqrt(vel_x^2+vel_y^2) to get r=1
arrow = arrow(length = unit(0.2, "cm")),size=1, colour='cyan')
plot_half_rink(p)
source("C:/Users/Paula/Desktop/Big-Data-Cup-2022-Private/code/visualization/hockey_pipeline.R")
l<-20
point_val = probs_to_point(x_puck,y_puck,calc_pass[l,],new_pass,tracking_data,'Canada',TRUE)
point_val[[1]]
point_val[[2]]
all_point_val <- apply(calc_pass,1,probs_to_point,x_puck=x_puck,y_puck=y_puck,all_ang=new_pass,tracks1=tracking_data,offence='Canada',want_plot=FALSE)
pass_potential <- bind_rows(all_point_val, .id = "column_label")
pass_potential
#pass_potential$pass_good = pass_potential$pass_good %>% rescale()
#geomtile, ggnewscale
# Create image of this frame with potential passes
#ggplot(data = pass_potential,aes(x=x, y=y)) + stat_density_2d(aes(fill = ..density..), geom = "raster", contour = FALSE)
p <- ggplot(data = pass_potential,aes(x = x, y = y)) +
geom_point(aes(color = pass_good),size=2, shape=16) +
scale_colour_gradient2(na.value="white",low = muted("blue"), mid = "white", high = muted("red"))+#,midpoint = 0.5
scale_x_continuous(expand = c(0, 0)) +
scale_y_continuous(expand = c(0, 0)) +
#geom_point(aes(x = x, y = y), size = 1, shape = 4)+
new_scale_fill() +
new_scale_color() +
geom_point(data=tracking_data,aes(x = x_ft, y = y_ft, fill = team_name), size = 5, shape = 21) +
geom_text(data=tracking_data,aes(x = x_ft, y = y_ft, label = jersey_number, colour = team_name), size = 3) +
geom_point(aes(x = x_puck+2, y = y_puck-0.5), size = 2, shape = 16, colour='black') +
scale_colour_manual(values = c("USA" = "white", "Canada" = "white")) +
scale_fill_manual(values = c("USA" = "blue", "Canada" = "red")) +
labs(fill = "Team") +
guides(colour = "none")+
geom_segment(data=tracking_data,aes(x = x_ft, y = y_ft, xend = x_ft+vel_x, yend = y_ft+vel_y), #/sqrt(vel_x^2+vel_y^2) to get r=1
arrow = arrow(length = unit(0.2, "cm")),size=1, colour='cyan')
plot_half_rink(p)
#geomtile, ggnewscale
# Create image of this frame with potential passes
#ggplot(data = pass_potential,aes(x=x, y=y)) + stat_density_2d(aes(fill = ..density..), geom = "raster", contour = FALSE)
p <- ggplot(data = cum_pass_good,aes(x = x, y = y)) +
geom_point(aes(color = pass_good),size=2, shape=16) +
scale_colour_gradient2(na.value="white",low = muted("blue"), mid = "white", high = muted("red"))+#,midpoint = 0.5
scale_x_continuous(expand = c(0, 0)) +
scale_y_continuous(expand = c(0, 0)) +
#geom_point(aes(x = x, y = y), size = 1, shape = 4)+
new_scale_fill() +
new_scale_color() +
geom_point(data=tracking_data,aes(x = x_ft, y = y_ft, fill = team_name), size = 5, shape = 21) +
geom_text(data=tracking_data,aes(x = x_ft, y = y_ft, label = jersey_number, colour = team_name), size = 3) +
geom_point(aes(x = x_puck+2, y = y_puck-0.5), size = 2, shape = 16, colour='black') +
scale_colour_manual(values = c("USA" = "white", "Canada" = "white")) +
scale_fill_manual(values = c("USA" = "blue", "Canada" = "red")) +
labs(fill = "Team") +
guides(colour = "none")+
geom_segment(data=tracking_data,aes(x = x_ft, y = y_ft, xend = x_ft+vel_x, yend = y_ft+vel_y), #/sqrt(vel_x^2+vel_y^2) to get r=1
arrow = arrow(length = unit(0.2, "cm")),size=1, colour='cyan')
#geomtile, ggnewscale
# Create image of this frame with potential passes
#ggplot(data = pass_potential,aes(x=x, y=y)) + stat_density_2d(aes(fill = ..density..), geom = "raster", contour = FALSE)
p <- ggplot(data = pass_potential,aes(x = x, y = y)) +
geom_point(aes(color = cum_pass_good),size=2, shape=16) +
scale_colour_gradient2(na.value="white",low = muted("blue"), mid = "white", high = muted("red"))+#,midpoint = 0.5
scale_x_continuous(expand = c(0, 0)) +
scale_y_continuous(expand = c(0, 0)) +
#geom_point(aes(x = x, y = y), size = 1, shape = 4)+
new_scale_fill() +
new_scale_color() +
geom_point(data=tracking_data,aes(x = x_ft, y = y_ft, fill = team_name), size = 5, shape = 21) +
geom_text(data=tracking_data,aes(x = x_ft, y = y_ft, label = jersey_number, colour = team_name), size = 3) +
geom_point(aes(x = x_puck+2, y = y_puck-0.5), size = 2, shape = 16, colour='black') +
scale_colour_manual(values = c("USA" = "white", "Canada" = "white")) +
scale_fill_manual(values = c("USA" = "blue", "Canada" = "red")) +
labs(fill = "Team") +
guides(colour = "none")+
geom_segment(data=tracking_data,aes(x = x_ft, y = y_ft, xend = x_ft+vel_x, yend = y_ft+vel_y), #/sqrt(vel_x^2+vel_y^2) to get r=1
arrow = arrow(length = unit(0.2, "cm")),size=1, colour='cyan')
plot_half_rink(p)
source("C:/Users/Paula/Desktop/Big-Data-Cup-2022-Private/code/visualization/hockey_pipeline.R")
all_point_val <- apply(calc_pass,1,probs_to_point,x_puck=x_puck,y_puck=y_puck,all_ang=new_pass,tracks1=tracking_data,offence='Canada',want_plot=FALSE)
pass_potential <- bind_rows(all_point_val, .id = "column_label")
pass_potential
#pass_potential$pass_good = pass_potential$pass_good %>% rescale()
#geomtile, ggnewscale
# Create image of this frame with potential passes
#ggplot(data = pass_potential,aes(x=x, y=y)) + stat_density_2d(aes(fill = ..density..), geom = "raster", contour = FALSE)
p <- ggplot(data = pass_potential,aes(x = x, y = y)) +
geom_point(aes(color = cum_pass_good),size=2, shape=16) +
scale_colour_gradient2(na.value="white",low = muted("blue"), mid = "white", high = muted("red"))+#,midpoint = 0.5
scale_x_continuous(expand = c(0, 0)) +
scale_y_continuous(expand = c(0, 0)) +
#geom_point(aes(x = x, y = y), size = 1, shape = 4)+
new_scale_fill() +
new_scale_color() +
geom_point(data=tracking_data,aes(x = x_ft, y = y_ft, fill = team_name), size = 5, shape = 21) +
geom_text(data=tracking_data,aes(x = x_ft, y = y_ft, label = jersey_number, colour = team_name), size = 3) +
geom_point(aes(x = x_puck+2, y = y_puck-0.5), size = 2, shape = 16, colour='black') +
scale_colour_manual(values = c("USA" = "white", "Canada" = "white")) +
scale_fill_manual(values = c("USA" = "blue", "Canada" = "red")) +
labs(fill = "Team") +
guides(colour = "none")+
geom_segment(data=tracking_data,aes(x = x_ft, y = y_ft, xend = x_ft+vel_x, yend = y_ft+vel_y), #/sqrt(vel_x^2+vel_y^2) to get r=1
arrow = arrow(length = unit(0.2, "cm")),size=1, colour='cyan')
plot_half_rink(p)
speed_puck = 55 #ft/s
source("C:/Users/Paula/Desktop/Big-Data-Cup-2022-Private/code/visualization/hockey_pipeline.R")
#r=0 # powerplay of interest
t_track=10 # shot of interest
# Set up the tracking data
#line1 <- paste('dat$relevant_events$\'',r,'\'$tracks$\'',t,'\'',sep='')
line1 <- paste('dat$tracks$\'',t_track,'\'',sep='')
line2 <- eval(parse(text=line1))
if(length(line2$frame_id)!=0){
json_tracks <- lapply(line2, function(x) {
x[sapply(x, is.null)] <- NA
unlist(x)
})
current_track <- as.data.frame(do.call("cbind", json_tracks))
}
current_track$frame_id = current_track$frame_id %>% as.integer()
current_track$period = current_track$period %>% as.integer()
current_track$track_id = current_track$track_id %>% as.integer()
current_track$jersey_number = current_track$jersey_number %>% as.integer()
current_track$x_ft = current_track$x_ft %>% as.double()
current_track$y_ft = current_track$y_ft %>% as.double()
current_track$vel_x = current_track$vel_x %>% as.double()
current_track$vel_y = current_track$vel_y %>% as.double()
# Set up the related event data
line3 <- paste('dat',sep='')
line4 <- eval(parse(text=line3))
if(length(dat$game_date)!=0){
json_events <- lapply(dat[1:28], function(x) {
x[sapply(x, is.null)] <- NA
unlist(x)
})
current_event_all <- as.data.frame(do.call("cbind", json_events))
}
current_event <- current_event_all[t_track+1,]
# Given a set location for the puck, find all potential spots the puck could be moved to
x_puck = current_event$x_coord %>% as.double()+3
y_puck = 85-current_event$y_coord %>% as.double()-4.5
theta = seq(-pi,pi,by=theta_scale)
passes = data.frame(angle=c(),x=c(),y=c(), t=c())
for(angle in theta){
passes = rbind(passes,cbind(angle,puck_motion_model2(x_puck,y_puck,angle)))
}
new_pass <- clean_pass(passes)
calc_pass <- new_pass %>% group_by(angle) %>% top_n(1, t)
# Select single frame to analyze
frame = current_event$frame_id_1 %>% as.integer()
tracking_data = current_track %>% filter(frame_id==frame)
event = current_event %>% filter(clock_seconds==frame)
tracking_data
# Create image of this frame with potential passes
plot_rink(ggplot(tracking_data)) +
geom_point(aes(x = x_ft, y = y_ft, fill = team_name), size = 5, shape = 21) +
geom_text(aes(x = x_ft, y = y_ft, label = jersey_number, colour = team_name), size = 3) +
geom_point(aes(x = x_puck+2, y = y_puck-0.5), size = 2, shape = 16, colour='black') +
geom_point(data = new_pass, aes(x = x, y = y), size = 1, shape = 4) +
scale_colour_manual(values = c("USA" = "white", "Canada" = "white")) +
scale_fill_manual(values = c("USA" = "blue", "Canada" = "red")) +
labs(fill = "Team") +
guides(colour = "none")+
geom_segment(aes(x = x_ft, y = y_ft, xend = x_ft+vel_x, yend = y_ft+vel_y), #/sqrt(vel_x^2+vel_y^2) to get r=1
arrow = arrow(length = unit(0.2, "cm")),size=1, colour='cyan')
plot_rink(ggplot(tracking_data)) +
geom_point(aes(x = x_ft, y = y_ft, fill = team_name), size = 5, shape = 21) +
geom_text(aes(x = x_ft, y = y_ft, label = jersey_number, colour = team_name), size = 3) +
geom_point(aes(x = x_puck+2, y = y_puck-0.5), size = 2, shape = 16, colour='black') +
geom_point(data = calc_pass, aes(x = x, y = y), size = 1, shape = 4) +
scale_colour_manual(values = c("USA" = "white", "Canada" = "white")) +
scale_fill_manual(values = c("USA" = "blue", "Canada" = "red")) +
labs(fill = "Team") +
guides(colour = "none")+
geom_segment(aes(x = x_ft, y = y_ft, xend = x_ft+vel_x, yend = y_ft+vel_y), #/sqrt(vel_x^2+vel_y^2) to get r=1
arrow = arrow(length = unit(0.2, "cm")),size=1, colour='cyan')
#As some players, such as the goalie are sometimes not moving, we give them a slight movement to avoid dividing by zero anywhere
tracking_data$vel_x[which(tracking_data$vel_x==0)]=0.05
tracking_data$vel_y[which(tracking_data$vel_y==0)]=0.05
offence <- 'Canada'
xyt <- new_pass %>% select(x,y,t)
loc_vel <- tracking_data %>% mutate(team_label = ifelse(team_name == offence,1,-1)) %>% select(x_ft,y_ft,vel_x,vel_y, team_label)
new_pass <- new_pass %>%
mutate(all_ctrl = teamwise_ice_ctrl_xyt(loc_vel, xyt), score_prob = apply(xyt,1,score_prob)) %>%
mutate(pass_value = score_prob * ((all_ctrl+1)/2)^3)
new_pass
l<-20
point_val = probs_to_point(x_puck,y_puck,calc_pass[l,],new_pass,tracking_data,'Canada',TRUE)
point_val[[1]]
point_val[[2]]
all_point_val <- apply(calc_pass,1,probs_to_point,x_puck=x_puck,y_puck=y_puck,all_ang=new_pass,tracks1=tracking_data,offence='Canada',want_plot=FALSE)
pass_potential <- bind_rows(all_point_val, .id = "column_label")
pass_potential
#pass_potential$pass_good = pass_potential$pass_good %>% rescale()
#geomtile, ggnewscale
# Create image of this frame with potential passes
#ggplot(data = pass_potential,aes(x=x, y=y)) + stat_density_2d(aes(fill = ..density..), geom = "raster", contour = FALSE)
p <- ggplot(data = pass_potential,aes(x = x, y = y)) +
geom_point(aes(color = cum_pass_good),size=2, shape=16) +
scale_colour_gradient2(na.value="white",low = muted("blue"), mid = "white", high = muted("red"))+#,midpoint = 0.5
scale_x_continuous(expand = c(0, 0)) +
scale_y_continuous(expand = c(0, 0)) +
#geom_point(aes(x = x, y = y), size = 1, shape = 4)+
new_scale_fill() +
new_scale_color() +
geom_point(data=tracking_data,aes(x = x_ft, y = y_ft, fill = team_name), size = 5, shape = 21) +
geom_text(data=tracking_data,aes(x = x_ft, y = y_ft, label = jersey_number, colour = team_name), size = 3) +
geom_point(aes(x = x_puck+2, y = y_puck-0.5), size = 2, shape = 16, colour='black') +
scale_colour_manual(values = c("USA" = "white", "Canada" = "white")) +
scale_fill_manual(values = c("USA" = "blue", "Canada" = "red")) +
labs(fill = "Team") +
guides(colour = "none")+
geom_segment(data=tracking_data,aes(x = x_ft, y = y_ft, xend = x_ft+vel_x, yend = y_ft+vel_y), #/sqrt(vel_x^2+vel_y^2) to get r=1
arrow = arrow(length = unit(0.2, "cm")),size=1, colour='cyan')
plot_half_rink(p)
#geomtile, ggnewscale
# Create image of this frame with potential passes
#ggplot(data = pass_potential,aes(x=x, y=y)) + stat_density_2d(aes(fill = ..density..), geom = "raster", contour = FALSE)
p <- ggplot(data = pass_potential,aes(x = x, y = y)) +
geom_point(aes(color = pass_good),size=2, shape=16) +
scale_colour_gradient2(na.value="white",low = muted("blue"), mid = "white", high = muted("red"))+#,midpoint = 0.5
scale_x_continuous(expand = c(0, 0)) +
scale_y_continuous(expand = c(0, 0)) +
#geom_point(aes(x = x, y = y), size = 1, shape = 4)+
new_scale_fill() +
new_scale_color() +
geom_point(data=tracking_data,aes(x = x_ft, y = y_ft, fill = team_name), size = 5, shape = 21) +
geom_text(data=tracking_data,aes(x = x_ft, y = y_ft, label = jersey_number, colour = team_name), size = 3) +
geom_point(aes(x = x_puck+2, y = y_puck-0.5), size = 2, shape = 16, colour='black') +
scale_colour_manual(values = c("USA" = "white", "Canada" = "white")) +
scale_fill_manual(values = c("USA" = "blue", "Canada" = "red")) +
labs(fill = "Team") +
guides(colour = "none")+
geom_segment(data=tracking_data,aes(x = x_ft, y = y_ft, xend = x_ft+vel_x, yend = y_ft+vel_y), #/sqrt(vel_x^2+vel_y^2) to get r=1
arrow = arrow(length = unit(0.2, "cm")),size=1, colour='cyan')
plot_half_rink(p)
#geomtile, ggnewscale
# Create image of this frame with potential passes
#ggplot(data = pass_potential,aes(x=x, y=y)) + stat_density_2d(aes(fill = ..density..), geom = "raster", contour = FALSE)
p <- ggplot(data = pass_potential,aes(x = x, y = y)) +
geom_point(aes(color = score_prob),size=2, shape=16) +
scale_colour_gradient2(na.value="white",low = muted("blue"), mid = "white", high = muted("red"))+#,midpoint = 0.5
scale_x_continuous(expand = c(0, 0)) +
scale_y_continuous(expand = c(0, 0)) +
#geom_point(aes(x = x, y = y), size = 1, shape = 4)+
new_scale_fill() +
new_scale_color() +
geom_point(data=tracking_data,aes(x = x_ft, y = y_ft, fill = team_name), size = 5, shape = 21) +
geom_text(data=tracking_data,aes(x = x_ft, y = y_ft, label = jersey_number, colour = team_name), size = 3) +
geom_point(aes(x = x_puck+2, y = y_puck-0.5), size = 2, shape = 16, colour='black') +
scale_colour_manual(values = c("USA" = "white", "Canada" = "white")) +
scale_fill_manual(values = c("USA" = "blue", "Canada" = "red")) +
labs(fill = "Team") +
guides(colour = "none")+
geom_segment(data=tracking_data,aes(x = x_ft, y = y_ft, xend = x_ft+vel_x, yend = y_ft+vel_y), #/sqrt(vel_x^2+vel_y^2) to get r=1
arrow = arrow(length = unit(0.2, "cm")),size=1, colour='cyan')
plot_half_rink(p)
#geomtile, ggnewscale
# Create image of this frame with potential passes
#ggplot(data = pass_potential,aes(x=x, y=y)) + stat_density_2d(aes(fill = ..density..), geom = "raster", contour = FALSE)
p <- ggplot(data = pass_potential,aes(x = x, y = y)) +
geom_point(aes(color = all_ctrl),size=2, shape=16) +
scale_colour_gradient2(na.value="white",low = muted("blue"), mid = "white", high = muted("red"))+#,midpoint = 0.5
scale_x_continuous(expand = c(0, 0)) +
scale_y_continuous(expand = c(0, 0)) +
#geom_point(aes(x = x, y = y), size = 1, shape = 4)+
new_scale_fill() +
new_scale_color() +
geom_point(data=tracking_data,aes(x = x_ft, y = y_ft, fill = team_name), size = 5, shape = 21) +
geom_text(data=tracking_data,aes(x = x_ft, y = y_ft, label = jersey_number, colour = team_name), size = 3) +
geom_point(aes(x = x_puck+2, y = y_puck-0.5), size = 2, shape = 16, colour='black') +
scale_colour_manual(values = c("USA" = "white", "Canada" = "white")) +
scale_fill_manual(values = c("USA" = "blue", "Canada" = "red")) +
labs(fill = "Team") +
guides(colour = "none")+
geom_segment(data=tracking_data,aes(x = x_ft, y = y_ft, xend = x_ft+vel_x, yend = y_ft+vel_y), #/sqrt(vel_x^2+vel_y^2) to get r=1
arrow = arrow(length = unit(0.2, "cm")),size=1, colour='cyan')
plot_half_rink(p)
x_puck
current_event$x_coord %>% as.double()+3
pass_potential %>% head()
#geomtile, ggnewscale
# Create image of this frame with potential passes
#ggplot(data = pass_potential,aes(x=x, y=y)) + stat_density_2d(aes(fill = ..density..), geom = "raster", contour = FALSE)
p <- ggplot(data = pass_potential,aes(x = x, y = y)) +
geom_point(aes(color = score_prob ),size=2, shape=16) +
scale_colour_gradient2(na.value="white",low = muted("blue"), mid = "white", high = muted("red"))+#,midpoint = 0.5
scale_x_continuous(expand = c(0, 0)) +
scale_y_continuous(expand = c(0, 0)) +
#geom_point(aes(x = x, y = y), size = 1, shape = 4)+
new_scale_fill() +
new_scale_color() +
geom_point(data=tracking_data,aes(x = x_ft, y = y_ft, fill = team_name), size = 5, shape = 21) +
geom_text(data=tracking_data,aes(x = x_ft, y = y_ft, label = jersey_number, colour = team_name), size = 3) +
geom_point(aes(x = x_puck+2, y = y_puck-0.5), size = 2, shape = 16, colour='black') +
scale_colour_manual(values = c("USA" = "white", "Canada" = "white")) +
scale_fill_manual(values = c("USA" = "blue", "Canada" = "red")) +
labs(fill = "Team") +
guides(colour = "none")+
geom_segment(data=tracking_data,aes(x = x_ft, y = y_ft, xend = x_ft+vel_x, yend = y_ft+vel_y), #/sqrt(vel_x^2+vel_y^2) to get r=1
arrow = arrow(length = unit(0.2, "cm")),size=1, colour='cyan')
plot_half_rink(p)
pass_potential
pass_potential$score_prob %>% summary()
pass_potential %>% summary()
source("C:/Users/Paula/Desktop/Big-Data-Cup-2022-Private/code/visualization/hockey_pipeline.R")
#r=0 # powerplay of interest
t_track=10 # shot of interest
# Set up the tracking data
#line1 <- paste('dat$relevant_events$\'',r,'\'$tracks$\'',t,'\'',sep='')
line1 <- paste('dat$tracks$\'',t_track,'\'',sep='')
line2 <- eval(parse(text=line1))
if(length(line2$frame_id)!=0){
json_tracks <- lapply(line2, function(x) {
x[sapply(x, is.null)] <- NA
unlist(x)
})
current_track <- as.data.frame(do.call("cbind", json_tracks))
}
current_track$frame_id = current_track$frame_id %>% as.integer()
current_track$period = current_track$period %>% as.integer()
current_track$track_id = current_track$track_id %>% as.integer()
current_track$jersey_number = current_track$jersey_number %>% as.integer()
current_track$x_ft = current_track$x_ft %>% as.double()
current_track$y_ft = current_track$y_ft %>% as.double()
current_track$vel_x = current_track$vel_x %>% as.double()
current_track$vel_y = current_track$vel_y %>% as.double()
# Set up the related event data
line3 <- paste('dat',sep='')
line4 <- eval(parse(text=line3))
if(length(dat$game_date)!=0){
json_events <- lapply(dat[1:28], function(x) {
x[sapply(x, is.null)] <- NA
unlist(x)
})
current_event_all <- as.data.frame(do.call("cbind", json_events))
}
current_event <- current_event_all[t_track+1,]
# Given a set location for the puck, find all potential spots the puck could be moved to
x_puck = current_event$x_coord %>% as.double()+3
y_puck = 85-current_event$y_coord %>% as.double()-4.5
theta = seq(-pi,pi,by=theta_scale)
passes = data.frame(angle=c(),x=c(),y=c(), t=c())
for(angle in theta){
passes = rbind(passes,cbind(angle,puck_motion_model2(x_puck,y_puck,angle)))
}
new_pass <- clean_pass(passes)
calc_pass <- new_pass %>% group_by(angle) %>% top_n(1, t)
# Select single frame to analyze
frame = current_event$frame_id_1 %>% as.integer()
tracking_data = current_track %>% filter(frame_id==frame)
event = current_event %>% filter(clock_seconds==frame)
tracking_data
#As some players, such as the goalie are sometimes not moving, we give them a slight movement to avoid dividing by zero anywhere
tracking_data$vel_x[which(tracking_data$vel_x==0)]=0.05
tracking_data$vel_y[which(tracking_data$vel_y==0)]=0.05
offence <- 'Canada'
xyt <- new_pass %>% select(x,y,t)
loc_vel <- tracking_data %>% mutate(team_label = ifelse(team_name == offence,1,-1)) %>% select(x_ft,y_ft,vel_x,vel_y, team_label)
new_pass <- new_pass %>%
mutate(all_ctrl = teamwise_ice_ctrl_xyt(loc_vel, xyt), score_prob = apply(xyt,1,score_prob)) %>%
mutate(pass_value = score_prob * ((all_ctrl+1)/2)^3)
new_pass
all_point_val <- apply(calc_pass,1,probs_to_point,x_puck=x_puck,y_puck=y_puck,all_ang=new_pass,tracks1=tracking_data,offence='Canada',want_plot=FALSE)
pass_potential <- bind_rows(all_point_val, .id = "column_label")
pass_potential
#pass_potential$pass_good = pass_potential$pass_good %>% rescale()
all_point_val <- apply(calc_pass,1,probs_to_point,x_puck=x_puck,y_puck=y_puck,all_ang=new_pass,tracks1=tracking_data,offence='Canada',want_plot=FALSE)
pass_potential <- bind_rows(all_point_val, .id = "column_label")
pass_potential
#pass_potential$pass_good = pass_potential$pass_good %>% rescale()
pass_potential
pass_potential %>% summary()
